import streamlit as st
import os
import time
from image_generator import ImageGenerator
from batch_image_generator import BatchImageGenerator
import glob
from PIL import Image

# --- é¡µé¢é…ç½® ---
st.set_page_config(
    page_title="Nano Banana - AI ç»˜å›¾å·¥åŠ",
    page_icon="ğŸŒ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --- è‡ªå®šä¹‰æ ·å¼ ---
st.markdown(r'''
    <style>
    .stButton>button {
        width: 100%;
    }
    .success-msg {
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: #d4edda;
        color: #155724;
    }
    </style>
    ''', unsafe_allow_html=True)

# --- åˆå§‹åŒ–çŠ¶æ€ ---
if 'img_gen' not in st.session_state:
    st.session_state.img_gen = ImageGenerator()
if 'batch_gen' not in st.session_state:
    st.session_state.batch_gen = BatchImageGenerator()

# --- ä¾§è¾¹æ  ---
st.sidebar.title("ğŸŒ AI ç»˜å›¾å·¥åŠ")
st.sidebar.markdown("---")
page = st.sidebar.radio(
    "åŠŸèƒ½å¯¼èˆª",
    ["âœ¨ å•å›¾åˆ›ä½œ (Playground)", "ğŸ­ æ‰¹é‡å·¥å‚ (Batch Factory)", "ğŸ–¼ï¸ ä½œå“ç”»å»Š (Gallery)"]
)

st.sidebar.markdown("---")
with st.sidebar.expander("âš™ï¸ å…¨å±€è®¾ç½®"):
    api_key_input = st.text_input("API Key", value=st.session_state.img_gen.config["auth"]["api_key"], type="password")
    if api_key_input != st.session_state.img_gen.config["auth"]["api_key"]:
        st.session_state.img_gen.config["auth"]["api_key"] = api_key_input
        st.session_state.img_gen.api_key = api_key_input
        st.session_state.img_gen.headers["Authorization"] = f"Bearer {api_key_input}"
        st.success("API Key å·²æ›´æ–°")

# --- é¡µé¢ 1: å•å›¾åˆ›ä½œ ---
if page == "âœ¨ å•å›¾åˆ›ä½œ (Playground)":
    st.header("âœ¨ å•å›¾åˆ›ä½œ")
    st.caption("å¿«é€Ÿæµ‹è¯• Promptï¼Œè°ƒè¯•é£æ ¼")

    col1, col2 = st.columns([1, 1])

    with col1:
        prompt_text = st.text_area("æç¤ºè¯ (Prompt)", height=150, placeholder="æè¿°ä½ æƒ³ç”Ÿæˆçš„ç”»é¢...")
        
        c1, c2, c3 = st.columns(3)
        with c1:
            size = st.selectbox("å°ºå¯¸", ["1024x1024", "1792x1024", "1024x1792"], index=0)
        with c2:
            quality = st.selectbox("ç”»è´¨", ["standard", "hd"], index=0)
        with c3:
            style = st.selectbox("é£æ ¼", ["vivid", "natural"], index=0)
        
        generate_btn = st.button("ğŸš€ ç”Ÿæˆå›¾ç‰‡", type="primary")

    with col2:
        if generate_btn and prompt_text:
            with st.spinner("æ­£åœ¨ç»˜åˆ¶ä¸­..."):
                # ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºæ–‡ä»¶å
                timestamp = int(time.time())
                filename = f"single_{timestamp}.png"
                
                # è°ƒç”¨ç°æœ‰åº“ç”Ÿæˆå¹¶ä¸‹è½½
                # ä¸´æ—¶ä¿®æ”¹é…ç½®ä»¥åŒ¹é…ç”¨æˆ·é€‰æ‹©
                original_config = st.session_state.img_gen.config.copy()
                st.session_state.img_gen.config["image"]["size"] = size
                st.session_state.img_gen.config["image"]["quality"] = quality
                st.session_state.img_gen.config["image"]["style"] = style
                
                save_path = st.session_state.img_gen.generate_and_download(
                    prompt_text, 
                    filename, 
                    folder="generated_images"
                )
                
                # æ¢å¤é…ç½®
                st.session_state.img_gen.config = original_config

                if save_path:
                    st.image(save_path, caption=f"Size: {size} | Style: {style}", use_container_width=True)
                    st.success(f"ä¿å­˜è‡³: {save_path}")
                else:
                    st.error("ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—")
        elif generate_btn and not prompt_text:
            st.warning("è¯·è¾“å…¥æç¤ºè¯")
        else:
            st.info("ğŸ‘ˆ åœ¨å·¦ä¾§è¾“å…¥æç¤ºè¯å¼€å§‹ç”Ÿæˆ")

# --- é¡µé¢ 2: æ‰¹é‡å·¥å‚ ---
elif page == "ğŸ­ æ‰¹é‡å·¥å‚ (Batch Factory)":
    st.header("ğŸ­ æ‰¹é‡ç”Ÿæˆå·¥å‚")
    st.caption("ç»„åˆ 'ç³»ç»Ÿé£æ ¼' ä¸ 'å†…å®¹éœ€æ±‚'ï¼Œæ‰¹é‡ç”Ÿäº§å›¾ç‰‡çŸ©é˜µ")

    tab1, tab2 = st.tabs(["é…ç½®ä¸ç”Ÿæˆ", "æç¤ºè¯ç®¡ç†"])

    with tab2:
        # æç¤ºè¯ç®¡ç†ç•Œé¢
        st.subheader("ğŸ“ ç³»ç»Ÿæç¤ºè¯ (Styles)")
        
        # æ·»åŠ æ–°ç³»ç»Ÿæç¤ºè¯
        with st.form("add_sys_prompt"):
            col_k, col_v, col_btn = st.columns([1, 3, 1])
            new_sys_key = col_k.text_input("Key (å¦‚: cyber_punk)")
            new_sys_val = col_v.text_input("Prompt (å¦‚: èµ›åšæœ‹å…‹é£æ ¼ï¼Œéœ“è™¹ç¯)")
            if col_btn.form_submit_button("æ·»åŠ "):
                if new_sys_key and new_sys_val:
                    st.session_state.batch_gen.add_system_prompt(new_sys_key, new_sys_val)
                    st.success(f"å·²æ·»åŠ : {new_sys_key}")
                    st.rerun()

        # æ·»åŠ æ–°éœ€æ±‚æç¤ºè¯
        st.subheader("ğŸ“ éœ€æ±‚æç¤ºè¯ (Contents)")
        with st.form("add_req_prompt"):
            col_req, col_btn2 = st.columns([3, 1])
            new_req = col_req.text_input("éœ€æ±‚å†…å®¹ (å¦‚: æœºå™¨äººå–å’–å•¡)")
            if col_btn2.form_submit_button("æ·»åŠ "):
                if new_req:
                    st.session_state.batch_gen.requirement_prompts.append(new_req)
                    st.session_state.batch_gen.save_config()
                    st.success("å·²æ·»åŠ éœ€æ±‚")
                    st.rerun()

    with tab1:
        # é€‰æ‹©è¦ç”Ÿæˆçš„ç»„åˆ
        st.subheader("1. é€‰æ‹©ç»„åˆ")
        
        col_sys, col_req = st.columns(2)
        
        with col_sys:
            st.markdown("**é€‰æ‹©é£æ ¼ (System Prompts)**")
            selected_systems = []
            # è·å–æ‰€æœ‰key
            sys_keys = list(st.session_state.batch_gen.system_prompts.keys())
            
            # å…¨é€‰/å…¨ä¸é€‰
            if st.checkbox("å…¨é€‰æ‰€æœ‰é£æ ¼"):
                selected_systems = sys_keys
            else:
                for key in sys_keys:
                    if st.checkbox(f"**{key}**: {st.session_state.batch_gen.system_prompts[key]}", key=f"sys_{key}"):
                        selected_systems.append(key)

        with col_req:
            st.markdown("**é€‰æ‹©å†…å®¹ (Requirement Prompts)**")
            selected_req_indices = []
            req_prompts = st.session_state.batch_gen.requirement_prompts
            
            if st.checkbox("å…¨é€‰æ‰€æœ‰éœ€æ±‚"):
                selected_req_indices = list(range(len(req_prompts)))
            else:
                for idx, prompt in enumerate(req_prompts):
                    if st.checkbox(f"{idx+1}. {prompt}", key=f"req_{idx}"):
                        selected_req_indices.append(idx)

        # é¢„è§ˆä¸æ‰§è¡Œ
        st.subheader("2. ç¡®è®¤å¹¶æ‰§è¡Œ")
        total_tasks = len(selected_systems) * len(selected_req_indices)
        
        st.info(f"ğŸ“Š é¢„è®¡ç”Ÿæˆä»»åŠ¡æ•°: **{len(selected_systems)}** (é£æ ¼) x **{len(selected_req_indices)}** (éœ€æ±‚) = **{total_tasks}** å¼ å›¾ç‰‡")
        
        if st.button("ğŸš€ å¼€å§‹æ‰¹é‡ç”Ÿæˆ", type="primary", disabled=total_tasks == 0):
            progress_bar = st.progress(0)
            status_text = st.empty()
            gallery_placeholder = st.container()
            
            completed = 0
            
            # åˆ›å»ºä¿å­˜ç›®å½•
            batch_folder = "batch_images"
            os.makedirs(batch_folder, exist_ok=True)

            for sys_key in selected_systems:
                for req_idx in selected_req_indices:
                    # å‡†å¤‡Prompt
                    sys_prompt = st.session_state.batch_gen.system_prompts[sys_key]
                    req_prompt = st.session_state.batch_gen.requirement_prompts[req_idx]
                    full_prompt = f"{sys_prompt} {req_prompt}"
                    
                    status_text.markdown(f"**æ­£åœ¨ç”Ÿæˆ ({completed+1}/{total_tasks})**: \n\nğŸ› ï¸ Style: `{sys_key}` \n\nğŸ“ Content: `{req_prompt}`")
                    
                    # æ–‡ä»¶å
                    filename = f"{sys_key}_{req_idx}.png"
                    
                    # è°ƒç”¨ç”Ÿæˆ (å¤ç”¨ img_gen)
                    save_path = st.session_state.img_gen.generate_and_download(
                        full_prompt,
                        filename,
                        folder=batch_folder
                    )
                    
                    if save_path:
                        st.toast(f"âœ… å®Œæˆ: {filename}")
                    else:
                        st.error(f"âŒ å¤±è´¥: {filename}")
                    
                    completed += 1
                    progress_bar.progress(completed / total_tasks)
                    
                    # é¿å…APIé€Ÿç‡é™åˆ¶ï¼Œç®€çŸ­æš‚åœ
                    if completed < total_tasks:
                        time.sleep(1)
            
            status_text.success("ğŸ‰ æ‰¹é‡ç”Ÿæˆä»»åŠ¡å…¨éƒ¨å®Œæˆï¼")

# --- é¡µé¢ 3: ç”»å»Š ---
elif page == "ğŸ–¼ï¸ ä½œå“ç”»å»Š (Gallery)":
    st.header("ğŸ–¼ï¸ ä½œå“ç”»å»Š")
    
    # è·å–æ‰€æœ‰å›¾ç‰‡
    image_files = []
    for ext in ["*.png", "*.jpg"]:
        image_files.extend(glob.glob(f"batch_images/{ext}"))
        image_files.extend(glob.glob(f"generated_images/{ext}"))
    
    # æŒ‰æ—¶é—´å€’åº
    image_files.sort(key=os.path.getmtime, reverse=True)
    
    if not image_files:
        st.info("æš‚æ— ç”Ÿæˆçš„å›¾ç‰‡ï¼Œå¿«å»ç”Ÿæˆä¸€å¼ å§ï¼")
    else:
        # ç­›é€‰
        filter_text = st.text_input("ğŸ” æœç´¢æ–‡ä»¶å...", "")
        if filter_text:
            image_files = [f for f in image_files if filter_text.lower() in f.lower()]
            
        # åˆ†é¡µæ˜¾ç¤º
        cols = st.columns(4)
        for idx, img_path in enumerate(image_files):
            with cols[idx % 4]:
                try:
                    image = Image.open(img_path)
                    st.image(image, use_container_width=True)
                    st.caption(os.path.basename(img_path))
                except Exception as e:
                    st.error(f"æ— æ³•åŠ è½½: {os.path.basename(img_path)}")
